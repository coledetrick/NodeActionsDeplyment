---
- name: Deploy Node.js App with Nginx
  hosts: nodejs
  become: true

  vars:
    app_dir: /home/ec2-user/app
    node_app_entry: app.js
    node_app_port: 3000
    nginx_config_path: /etc/nginx/conf.d/nodeapp.conf

  tasks:
    - name: Install required packages
      yum:
        name:
          - nodejs
          - nginx
          - rsync
        state: present

    - name: Ensure pm2 is installed globally
      npm:
        name: pm2
        global: yes
        state: present

    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ec2-user
        group: ec2-user
        mode: "0755"

    # Copy repo contents from GitHub runner -> EC2
    - name: Sync app code to EC2
      synchronize:
        src: "{{ playbook_dir }}/../"   # repo root (playbook is in Ansible/)
        dest: "{{ app_dir }}/"
        recursive: true
        delete: true

    - name: Ensure app files owned by ec2-user
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ec2-user
        group: ec2-user
        recurse: true

    - name: Verify package.json exists
      stat:
        path: "{{ app_dir }}/package.json"
      register: pkg

    - name: Fail if package.json is missing
      fail:
        msg: "package.json not found at {{ app_dir }}/package.json. Check repo layout or sync src path."
      when: not pkg.stat.exists

    - name: Install npm dependencies (production)
      become_user: ec2-user
      command: npm install --omit=dev
      args:
        chdir: "{{ app_dir }}"

    - name: Start or restart app with PM2
      become_user: ec2-user
      shell: |
        pm2 start {{ app_dir }}/{{ node_app_entry }} --name node_app || pm2 restart node_app
        pm2 save
      args:
        chdir: "{{ app_dir }}"

    - name: Enable PM2 startup on boot
      shell: |
        pm2 startup systemd -u ec2-user --hp /home/ec2-user
      args:
        creates: /etc/systemd/system/pm2-ec2-user.service

    - name: Ensure Nginx is enabled and started
      systemd:
        name: nginx
        state: started
        enabled: yes

    - name: Configure Nginx for Node.js app
      copy:
        dest: "{{ nginx_config_path }}"
        content: |
          server {
              listen 80;
              server_name _;

              location / {
                  proxy_pass http://127.0.0.1:{{ node_app_port }};
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_cache_bypass $http_upgrade;
              }
          }
        owner: root
        group: root
        mode: "0644"

    - name: Reload Nginx to apply config
      systemd:
        name: nginx
        state: reloaded
